name: Update Invidious List

on:
  pull_request:
  push:
    branches:
      - main
  schedule:
    # Runs every 10 minutes
    - cron: "*/10 * * * *"
    
permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      # Must check out using the token to enable authenticated pushing later
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'
    
    # 1. Run the main script which generates iv.txt and updates iv.json
    - name: Run Instance Updater Script
      run: node updater.ts
    
    # 2. Configure Git and Perform Commit/Push (FIXED ORDER)
    - name: Commit and Push Files via Git CLI
      run: |
        # Configure Git user details for the commit
        git config user.name "GitHub Actions Bot"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        # Check if the files were actually modified
        if git diff --exit-code iv.txt iv.json > /dev/null; then
          echo "No changes found in iv.txt or iv.json. Skipping commit."
        else
          echo "Changes detected. Creating local commit first..."
          
          # 1. Stage both files
          git add iv.txt iv.json
          
          # 2. Commit the changes locally
          git commit -m "Chore: Automated update of Invidious list and history"
          
          # 3. FIX: Now pull and rebase. Git will see a clean working tree.
          git pull --rebase origin main
          
          # 4. Push the integrated commit
          git push
        fi
